<!doctype html><!-- start coded_template: id:3368679407 path:generated_layouts/3368679387.html --><!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en" > <![endif]--><!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en" >        <![endif]--><!--[if IE 8]>    <html class="no-js lt-ie9" lang="en" >               <![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]--><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="author" content="Ariel Koren">
    <meta name="description" content="Seculert's Ariel Koren conducts another deep technical dive, this time into Nymaim, a clever, evasive malware actively circulating the web.">
    <meta name="generator" content="HubSpot">
    <title>Nymaim: Deep Technical Dive - Adventures in Evasive Malware</title>
    <link rel="shortcut icon" href="http://info.seculert.com/hs-fs/hub/237610/file-2170643530-png/New_Logos/Favicon/favicon.png?t=1475841733970">
    

    <script src="https://static.hsstatic.net/jquery-libs/static-1.1/jquery/jquery-1.7.1.js"></script>
    <script type="text/javascript">hsjQuery = window['jQuery']</script>
    <link href="https://static.hsstatic.net/content_shared_assets/static-1.4032/css/public_common.css" rel="stylesheet">
    <meta property="og:description" content="Seculert's Ariel Koren conducts another deep technical dive, this time into Nymaim, a clever, evasive malware actively circulating the web.">
    <meta property="og:title" content="Nymaim: Deep Technical Dive - Adventures in Evasive Malware">
    <meta name="twitter:description" content="Seculert's Ariel Koren conducts another deep technical dive, this time into Nymaim, a clever, evasive malware actively circulating the web.">
    <meta name="twitter:title" content="Nymaim: Deep Technical Dive - Adventures in Evasive Malware">


    
    

    
<!--  Added by GoogleAnalytics integration -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18853661-2', 'auto');
  ga('send', 'pageview');
</script>

<!-- /Added by GoogleAnalytics integration -->

    


    <!--[if lt IE 9]>
    <script src="https://static.hsstatic.net/content_shared_assets/static-1.4032/js/css3-mediaqueries.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700" rel="stylesheet" type="text/css">
<link href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" rel="stylesheet" type="text/css">
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
<script src="http://cdn2.hubspot.net/hub/237610/hub_generated/template_assets/1461813004010/custom/page/NewSeculertJavascripts/init.min.js"></script>
<script src="http://cdn2.hubspot.net/hub/237610/hub_generated/style_manager/1444641212357/custom/page/NewSeculertJavascripts/autodemo.min.js"></script>
<script type="text/javascript" language="javascript"> 
      var sf14gv = 24181; 
      (function() { 
      var sf14g = document.createElement('script'); sf14g.type = 'text/javascript'; sf14g.async = true; 
      sf14g.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 't.sf14g.com/sf14g.js'; 
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sf14g, s); 
      })(); 
</script>




<meta property="og:image" content="http://www.seculert.com/hubfs/NymaimLogo.jpg#keepProtocol">
<meta name="twitter:image" content="http://www.seculert.com/hubfs/NymaimLogo.jpg#keepProtocol">

<meta property="og:url" content="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware">

<link rel="canonical" href="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware">

<meta property="og:type" content="article">
<link rel="alternate" type="application/rss+xml" href="http://www.seculert.com/blogs/rss.xml">
<meta name="twitter:card" content="summary">
<meta name="twitter:domain" content="www.seculert.com">
<meta name="twitter:site" content="@seculert">
<script src="http://platform.linkedin.com/in.js" type="text/javascript">
    lang: en_US
</script>

<link href="http://cdn2.hubspot.net/hub/-1/hub_generated/style_manager/1472825336927/hubspot_default/shared/responsive/layout.min.css" rel="stylesheet">


<link rel="stylesheet" href="http://cdn2.hubspot.net/hub/237610/hub_generated/template_assets/1475373827989/custom/page/basic/NewSeculertMaterializeStylesheet.min.css">
<link rel="stylesheet" href="http://cdn2.hubspot.net/hub/237610/hub_generated/template_assets/1461829987651/custom/email/basic/NewSeculertStylesheet.min.css">


    <!-- The style tag has been deprecated. Attached stylesheets are included in the required_head_tags page variable. -->

</head>
<body class="   hs-content-id-4401471434 hs-blog-post hs-content-path-blogs-nymaim-deep-technical-dive-adventures-in-eva hs-content-name-nymaim-deep-technical-dive-adventures-in-evasive-m hs-blog-name-blogs hs-blog-id-294026020" style="">
    <div class="header-container-wrapper">
    <div class="header-container container-fluid">


    </div><!--end header -->
</div><!--end header wrapper -->

<div class="body-container-wrapper">
    <div class="body-container container-fluid">

<div class="row-fluid-wrapper row-depth-1 row-number-1 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-global_widget " style="" data-widget-type="global_widget" data-x="0" data-w="12">
<div class="cell-wrapper layout-widget-wrapper">
<span id="hs_cos_wrapper_newseculert_menu" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_raw_html" style="" data-hs-cos-general-type="widget" data-hs-cos-type="raw_html" data-global-widget-id="3324262294"><div class="navbar-fixed">
  <nav class="an-transparent" role="navigation">
    <div class="nav-wrapper container">
      <a id="logo-container" href="/home-page" class="brand-logo"><img src="/hubfs/NewSeculertImages/logo-seculert.png" alt=""></a>
          <ul class="an-sub-link right hide-on-med-and-down">
            <li><a href="/blogs" title="Blog" class="btn-flat bnt-cutom-flat">Blog</a></li>
            <li><a class="waves-effect waves-light btn" title="Contact Us" href="/new-contact">Contact Us</a></li>
          </ul>  
           <div class="clearfix"></div>
          <ul id="coolMenu" class="right hide-on-med-and-down an-coolMenu">
           <li>
            <a href="/solutions" linkhref="solutions">solutions</a>
            <ul class="noJS">
                <li><a href="/solutions#Seculert_Javelin">Seculert Javelin</a></li>
                <li><a href="/solutions#Seculert_Shield">Seculert Shield</a></li>
                <li><a href="/solutions#How_It_Works">How It Works</a></li>
                
            </ul>
        </li>
        <li>
            <a href="/why-seculert" linkhref="why-seculert">why seculert?</a>
            <ul class="noJS">
                <li><a href="/why-seculert#why_seculert">Why Seculert</a></li>
                <li><a href="/why-seculert#our_approach">Our Approach</a></li>
                <li><a href="/why-seculert#technology">Technology</a></li>
            </ul>
        </li>
        <li><a href="/customer-page" linkhref="customer-page">customers</a></li>
        <li><a href="/partners" linkhref="partners">partners</a></li>
        <li>
            <a href="/resources-page" linkhref="resources-page">resources</a>
            <ul class="noJS">
                <li><a href="/resources-page#data_sheet">Data Sheets</a></li>
                <li><a href="/resources-page#white_paper">White Papers</a></li>
                <li><a href="/resources-page#webinar">Webinars</a></li>
                <li><a href="/resources-page#report">Reports</a></li>
            </ul>
        </li>
		<li>
           <a href="/company" linkhref="company">company</a>
           <ul class="noJS">
                <li><a href="/company#about_us">About Us</a></li>
                <li><a href="/company#news_events">PR &amp; News</a></li>
                <li><a href="/company#research">Research</a></li>
                <li><a href="/company#management_team">Leadership</a></li>
                <li><a href="/company#career">Careers</a></li>
                
            </ul>
        </li>
      </ul>
        
      <ul id="nav-mobile" class="side-nav">
        <li class="no-padding">
          <ul class="collapsible" data-collapsible="accordion">
            <li><a class="collapsible-header">solutions <i class="fa fa-fw">?</i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="/solutions#Seculert_Javelin">Seculert Javelin</a></li>
                    <li><a href="/solutions#Seculert_Shield">Seculert Shield</a></li>
                    <li><a href="/solutions#How_it_Works">How it Works</a></li>

                </ul>
              </div>
            </li>
          </ul>
        </li>
		<li class="no-padding">
          <ul class="collapsible" data-collapsible="accordion">
            <li><a class="collapsible-header">why seculert? <i class="fa fa-fw">?</i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="/why-seculert#why_seculert">Why Seculert</a></li>
                    <li><a href="/why-seculert#our_approach">Our Approach</a></li>
                    <li><a href="/why-seculert#technology">Technology</a></li>
                </ul>
              </div>
            </li>
          </ul>
        </li>
		<li><a href="/customer-page">customers</a></li>
        <li><a href="/partners">partners</a></li>
        <li class="no-padding">
          <ul class="collapsible" data-collapsible="accordion">
            <li><a class="collapsible-header">resources <i class="fa fa-fw">?</i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="/resources-page#data_sheet">Data Sheets</a></li>
                    <li><a href="/resources-page#white_paper">White Papers</a></li>
                    <li><a href="/resources-page#webinar">Webinars</a></li>
                    <li><a href="/resources-page#report">Reports</a></li>
                </ul>
              </div>
            </li>
          </ul>
        </li>
        <li class="no-padding">
          <ul class="collapsible" data-collapsible="accordion">
            <li><a class="collapsible-header">company <i class="fa fa-fw">?</i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="/company#about_us">About Us</a></li>
                    <li><a href="/company#news_events">PR &amp; News</a></li>
                    <li><a href="/company#research">Research</a></li>
                    <li><a href="/company#management_team">Leadership</a></li>
                    <li><a href="/company#career">Careers</a></li>
                </ul>
              </div>
            </li>
          </ul>
        </li>
        <li><a href="/blogs" title="Blogs">Blogss</a></li>
        <li><a href="/new-contact" title="Contact Us">Contact Us</a></li>
      </ul>
      <a href="#" data-activates="nav-mobile" class="button-collapse">menu<i class="material-icons"></i></a>
    </div>
  </nav>
</div></span></div><!--end layout-widget-wrapper -->
</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-2 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-raw_html " style="" data-widget-type="raw_html" data-x="0" data-w="12">
<div class="cell-wrapper layout-widget-wrapper">
<span id="hs_cos_wrapper_module_14430704855787658" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_raw_html" style="" data-hs-cos-general-type="widget" data-hs-cos-type="raw_html"><div class="an-content-header-blog">
<div id="index-banner" class="parallax-container">
<div class="section no-pad-bot">
<div class="container">
<h5 class="header center col s12">latest insights</h5>
<h2 class="header center">seculert blog</h2>
</div>
</div>
<div class="parallax"><img src="http://www.seculert.com/hubfs/NewSeculertImages/background2.png?t=1475841733970" alt="Unsplashed background img 1"></div>
</div>
</div></span>
</div><!--end layout-widget-wrapper -->
</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-3 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-cell " style="" data-widget-type="cell" data-x="0" data-w="12">

<div class="row-fluid-wrapper row-depth-1 row-number-4 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-blog_content " style="" data-widget-type="blog_content" data-x="0" data-w="12">
<div class="container">
     <div class="an-content-section">
         <div class="row">
            <div class="col s12 m8 l9 an-content-left">
                 <div class="an-item-blog an-item-blog-detail">
                    
                    <img src="http://www.seculert.com/hubfs/NymaimLogo.jpg?t=1475841733970" alt="" class="responsive-img">
                    
                    <h3><a href="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware" title=""><span id="hs_cos_wrapper_name" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="text">Nymaim: Deep Technical Dive - Adventures in Evasive Malware</span></a></h3>
                    <div class="an-group-link">
                        <span>by <a class="author-link" href="http://www.seculert.com/blogs/author/ariel-koren">Ariel Koren</a></span>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
                        <span>Oct 11, 2016 5:30:00 AM</span>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
                        
                        
                        <span>0 Comments</span>
                    </div> 
                    <p>
                        <span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"></span></p><p><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;">Nymaim is mostly known worldwide as a downloader, although it seems they evolved from former versions, now having new functionalities to obtain data on the machine with no need to download a new payload. Some of the exported functionalities allow harvesting passwords and browsers data from the machine, hidden on the file system until communication occurs. Payloads downloaded from the C&amp;C are not saved locally on the machine but instead are loaded dynamically to memory with a unique internal calling convention.</span></span></p>
<p><span style="font-weight: 400; color: #000000;">One of the signature features I noticed when I began analyzing the Nymaim payload were the novel anti-reverse engineering and obfuscation techniques. Frustrating the analyzer many different code pieces for the same function requires piecing them together in order to fully understand the code. Most of the code is heavily obfuscated using ‘spaghetti code’ methods but we'll dive into that in a 1 (bit).</span></p>
<!--more-->
<p><span style="font-weight: 400; color: #000000;">In addition to the already obfuscated code, the DGA (Domain generation algorithm) use quite an interesting technique to make sure it won't be sink-holed easily, as well as further challenging analyzation.</span></p>
<p><span style="font-weight: 400; color: #000000;">In this blog, I will review the anti-reverse engineering techniques the malware authors implemented in the code, explain the unique DGA they made, and show different automation concepts to conquer the code and make the analyzer’s life a lot easier.</span></p>
<p>&nbsp;</p>
<h1><span style="font-weight: 400; font-size: 18px;"><strong>And so it begins...</strong></span></h1>
<p><span style="font-weight: 400; color: #000000;">In general, when I dive into a new malware, I begin with a set of goals or objectives I need to discover and understand such as the DGA mechanism of a malware, or analyzing the protocol and functionality. When I focus on the DGA for instance, while debugging, I expect the malware to hit (at some point) a DNS resolving function such as </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">getaddrinfo</code><span style="font-weight: 400;">, </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">gethostbyname</code><span style="font-weight: 400; color: #000000;"> or any similar API. Unfortunately, Nymaim hit none of the expected DNS resolving APIs exported. Confused for a moment, I decided to try a breakpoint on the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function and indeed the breakpoint is hit. It is a crafted DNS request with a messed up Call Stack and I can't conclude anything definitive, I have to find the caller to the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function manually. Following the RETs and JMPs I finally get to the function called the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function. But wait, it looks so weird! (Dramatic drumming)</span></p>
<div style="text-align: center;"><span style="font-weight: 400;"><img src="http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=685&amp;height=503&amp;name=sendto_ida_snippet.jpg" alt="" title="sendto_ida_snippet.jpg" width="685" height="503" data-constrained="true" style="display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=343&amp;height=252&amp;name=sendto_ida_snippet.jpg 343w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=685&amp;height=503&amp;name=sendto_ida_snippet.jpg 685w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=1028&amp;height=755&amp;name=sendto_ida_snippet.jpg 1028w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=1370&amp;height=1006&amp;name=sendto_ida_snippet.jpg 1370w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=1713&amp;height=1258&amp;name=sendto_ida_snippet.jpg 1713w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=2055&amp;height=1509&amp;name=sendto_ida_snippet.jpg 2055w" sizes="(max-width: 685px) 100vw, 685px"></span><span style="font-weight: 400; color: #999999;">(Fig. 1, the calling convention to the sendto function)</span></div>
<p><span style="font-weight: 400; color: #000000;">no way this is the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function!</span></p>
<h1><strong>So, it continues! Obfuscation, legit code protection</strong></h1>
<p><span style="font-weight: 400; color: #000000;">Let us examine the IDA snippet above (Fig. 1), while keeping in mind what the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function looks like:<br><br></span></p>
<table style="height: 169px; background-color: #ffffff; margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">WS2_32!sendto(SOCKET s,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *buf,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; int len,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int flags,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const struct sockaddr *to,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int tolen)</span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">There are 6 arguments in total. After static analysis of the code, the arguments passed on the stack don’t make much sense in terms of what </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> is expecting (value wise). Also there are 9 push opcodes in total. Something fishy is going on in there. Let's examine the last call function </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">call sub_1805525</code><span style="font-weight: 400; color: #000000;"> which is the OPCODE I returned to manually from the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function.</span></p>
<p><span style="font-weight: 400; color: #000000;">&lt;SpoilerAlert&gt;<br></span><span style="font-weight: 400; color: #000000;">&nbsp; &nbsp; This function is one of many spaghetti functions found in the code<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">&lt;/SpoilerAlert&gt;</span></span></p>
<p><span style="font-weight: 400;"><span style="font-weight: 400;"><img src="http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=640&amp;name=call_function.jpg" title="call_function.jpg" width="640" data-constrained="true" style="width: 640px; display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=320&amp;name=call_function.jpg 320w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=640&amp;name=call_function.jpg 640w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=960&amp;name=call_function.jpg 960w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=1280&amp;name=call_function.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=1600&amp;name=call_function.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=1920&amp;name=call_function.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"></span></span></p>
<div style="text-align: center;"><span style="font-weight: 400; color: #999999;">(Fig. 2, How the called function looks like)</span></div>
<p><span style="font-weight: 400;"><span style="font-weight: 400;">&nbsp;</span></span></p>
<p>&nbsp;</p>
<img src="http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=203&amp;height=300&amp;name=stack.jpg" alt="" title="stack.jpg" width="203" height="300" data-constrained="true" style="float: right;" srcset="http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=102&amp;height=150&amp;name=stack.jpg 102w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=203&amp;height=300&amp;name=stack.jpg 203w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=305&amp;height=450&amp;name=stack.jpg 305w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=406&amp;height=600&amp;name=stack.jpg 406w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=508&amp;height=750&amp;name=stack.jpg 508w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=609&amp;height=900&amp;name=stack.jpg 609w" sizes="(max-width: 203px) 100vw, 203px">
<p><span style="font-weight: 400; color: #000000;">To fully comprehend what is going on, we will first have to understand how the stack would look after calling this function in terms of EBP offsets:</span></p>
<p><span style="font-weight: 400; color: #000000;">First of all pushing EAX (arg_8) and then two more DWORDS, arg_4 (0xCF260F5F) and arg_0 (0x30D8FC16).</span></p>
<p><span style="font-weight: 400; color: #000000;">Then calling the function (call sub_1805525) which will put the appropriate ret address as the last value on the stack and that’s all we need to know stack-wise for now when calling this function.</span></p>
<p><span style="font-weight: 400; color: #000000;">Then, inside the called function, the function's prologue happens</span></p>
<p>&nbsp;</p>
<table style="height: 35px; margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 261.6px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">push ebp<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;">mov ebp, esp</span></span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">This puts into the base register (EBP) the current stack address to relatively point to stack variables using EBP and not ESP. Let's see what this function does exactly (As seen on the IDA snippet above):</span></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">(0) + (1) Overwrite </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">arg_8</code><span style="font-weight: 400; color: #000000;"> with the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">RetAddress</code><span style="font-weight: 400; color: #000000;">, (2) + (3) sum the values of the two DWORDS pushed on the stack (</span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">arg_0 + arg_4</code><span style="font-weight: 400; color: #000000;">), (4) the result from the last operation will be added to the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">arg_8</code><span style="font-weight: 400; color: #000000;"> which was already overwritten with the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">RetAddress</code><span style="font-weight: 400;">.</span></p>
<p><span style="font-weight: 400; color: #000000;">Basically it receives two numbers and a dummy stack value, 3 arguments in total. Resulting in a new return address with the value of <code style="font-weight: 400; color: #111111; background-color: #eeeeee;">[ReturnAddress + arg_0 + arg_4]</code>.</span></p>
<p><span style="font-weight: 400; color: #000000;">Xreferencing this whole mathematical function shows me it is being called from 36 more places. There are dozens (!) more variants of this function and about 2600 different places in which all of the variants being called inside the code.</span></p>
<p><span style="font-weight: 400; color: #000000;">Back to analyzing, the new address should be:</span></p>
<p><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">[0x0183BF0B + 0x30D8FC16 + 0XCF260F5F]</code><span style="font-weight: 400; color: #000000;">, cutting the 32 bit part will result in </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">[0x0182CA80]</code></p>
<p style="text-align: center;"><img src="http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=598&amp;height=1046&amp;name=func_wrapper.jpg" alt="" title="func_wrapper.jpg" width="598" height="1046" data-constrained="true" srcset="http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=299&amp;height=523&amp;name=func_wrapper.jpg 299w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=598&amp;height=1046&amp;name=func_wrapper.jpg 598w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=897&amp;height=1569&amp;name=func_wrapper.jpg 897w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=1196&amp;height=2092&amp;name=func_wrapper.jpg 1196w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=1495&amp;height=2615&amp;name=func_wrapper.jpg 1495w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=1794&amp;height=3138&amp;name=func_wrapper.jpg 1794w" sizes="(max-width: 598px) 100vw, 598px">&nbsp;<br><span style="font-weight: 400; color: #999999;">(Fig. 3, API obfuscation for some api calls, sendto commented)</span></p>
<p><span style="font-weight: 400; color: #000000;">Great success! The above snippet (Fig. 3) is another part of the obfuscation. The function that would be called next (</span><strong><i>sub_180D32D</i></strong><span style="font-weight: 400; color: #000000;">) is some API-Wrapper. Actually there are no standard API calls anywhere in the code, everything is calculated dynamically... everything. It's terrible I know.</span></p>
<p><span style="font-weight: 400; color: #000000;">Diving into that API-Wrapper function is possible (and actually required for the most part). However I won't do that in the scope of this blog post.</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">So this spaghetti calling convention messes up the code and I will have to fix it if I want to do any effective static analysis of it. Before I present the solution for this problem, however, Let's examine the rest of the unresolved issues in the calling function to </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400;">.</span><br></span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;"><img src="http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=640&amp;name=reg_push.jpg" title="reg_push.jpg" width="640" data-constrained="true" style="display: block; margin-left: auto; margin-right: auto; width: 640px;" srcset="http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=320&amp;name=reg_push.jpg 320w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=640&amp;name=reg_push.jpg 640w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=960&amp;name=reg_push.jpg 960w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=1280&amp;name=reg_push.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=1600&amp;name=reg_push.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=1920&amp;name=reg_push.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"></span></span></p>
<p style="text-align: center;"><span style="font-weight: 400; color: #999999;">(Fig. 4, Caller to the sendto function, extra unresolved code)</span></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">The next thing we need to investigate, is the repeated function </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sub_183AC7E</code></p>
<p style="text-align: center;"><strong><i><img src="http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=640&amp;name=reg_push-1.jpg" title="reg_push-1.jpg" width="640" data-constrained="true" style="display: block; margin-left: auto; margin-right: auto; width: 640px;" srcset="http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=320&amp;name=reg_push-1.jpg 320w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=640&amp;name=reg_push-1.jpg 640w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=960&amp;name=reg_push-1.jpg 960w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=1280&amp;name=reg_push-1.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=1600&amp;name=reg_push-1.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=1920&amp;name=reg_push-1.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"></i></strong><span style="font-weight: 400; color: #999999;">(Fig. 5, push register obfuscation)</span></p>
<p style="text-align: center;">&nbsp;</p>
<p style="text-align: left;"><span style="font-weight: 400; color: #999999;"><span style="font-weight: 400; color: #000000;">I will make it easy, This is a huge switch-case of putting a register value on the stack dependent of the given value. For example, the following code (our </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> scenario):</span></span></p>
<p style="text-align: left;">&nbsp;</p>
<table style="height: 35px; background-color: margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 261.6px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">seg000:0183BED7 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">10h<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BED9 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">72h ; 'r'<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEDB &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">call</span> <span style="font-weight: 400; color: #000000;">sub_183AC7E<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEE0 &nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push</span> <span style="font-weight: 400; color: #000000;">6Fh ; 'o'<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEE2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">call</span> <span style="font-weight: 400; color: #000000;">sub_183AC7E<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEE7 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">6Ch ; 'l'<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEE9 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">call</span> <span style="font-weight: 400; color: #000000;">sub_183AC7E<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEEE &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">73h ; 's'<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEF0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call &nbsp; sub_183AC7E<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">seg000:0183BEF5 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">dword ptr [ebp-184h]</span></span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<table style="height: 35px; background-color: #ffffff; margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 261.6px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">10h<br></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">esi<br></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">ebx<br></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">eax<br></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">edi<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">dword ptr [ebp-184h]</span></span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h1 style="text-align: left;"><span style="font-weight: 400; color: #000000; font-size: 30px;"><span style="font-weight: 400; color: #000000;"><strong>Tomāto-Tomăto, Potāto-Potăto It’s all the same to…</strong></span></span></h1>
<p><span style="font-weight: 400; color: #000000;">...the two problems I aim to solve. One is fixing that spaghetti code-calling convention, and to fix the <code style="font-weight: 400; color: #111111; background-color: #eeeeee;">push_reg</code> function. These two functions rule most of the code, so fixing these two should be a huge step forward in understanding the code and statically analyzing it.</span><span style="font-weight: 400;"><br><br></span></p>
<p><span style="font-weight: 400; color: #000000;">So how is it done? Easy, Magic!</span></p>
<p><span style="font-weight: 400; color: #000000;">or in its unofficial name, IDA-Python, scripting an automation process to go over all of the code, wherever one of these functions occur, fix it and change it to a simpler and more readable code format while retaining the same functionality.</span></p>
<p><span style="font-weight: 400; color: #000000;">So let's get practical shall we? Starting with the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">push_reg</code><span style="font-weight: 400; color: #000000;"> function</span></p>
<p><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;"><strong><span style="font-weight: 400;">I need to change every call to that function, which is made up of two opcodes:</span></strong></span></span></p>
<table style="height: 35px; margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 261.6px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">6A XX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">&lt;BYTE&gt;<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;"><span style="font-weight: 400; color: #000000;">E8 XX XX XX XX &nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">call</span> <span style="font-weight: 400;">&lt;DWORD&gt;</span></span></span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Push and Call, which are both in total 7 bytes in memory. If I could replace these 7 bytes with the appropriate values of the Push &lt;Register&gt; and do it over all of the code, it will be a big step in de-obfuscating the code.</span></p>
<p><span style="font-weight: 400; color: #000000;">So now that I know exactly what I want to replace, I wrote a script which does exactly that:</span></p>
<p>&nbsp;</p>
<pre class="brush: py">PUSH_REGISTER_ADDR = 0x0183AC7E
PUSH_REG_VALUE = 0x6C
SIZEOF_PUSH_BYTE = 2
 
def fix_reg_push(function_address):
               patched_counter = 0
               unpatched_counter = 0
               values_to_patch = {PUSH_REG_VALUE : 0x50,       	# push eax
                          	PUSH_REG_VALUE + 1 : 0x51,   	# push ecx
                          	PUSH_REG_VALUE + 2 : 0x52,   	# push edx
                          	PUSH_REG_VALUE + 3 : 0x53,   	# push ebx
                          	PUSH_REG_VALUE + 5 : 0x55,   	# push ebp
                          	PUSH_REG_VALUE + 6 : 0x56,   	# push esi
                          	PUSH_REG_VALUE + 7 : 0x57,   	# push edi}
 
           	# Go through all xrefs
           	for xcall in XrefsTo(function_address):
           	
                          	# Make code if is not already
                          	opcode_length = idc.MakeCode(xcall.frm - SIZEOF_PUSH_BYTE)
                          	if SIZEOF_PUSH_BYTE != opcode_length:
                                         	print " [*] fix_reg_push not code [0x%08X]" % push_addr
                                         	not_code_counter += 1
                                         	continue
                                         	
                          	# Obtain previous opcode address
                          	push_addr = idc.PrevHead(xcall.frm)
                          	
                          	# Sanity check 2
                          	if "push" != GetMnem(push_addr):
                                         	print " [*] fix_reg_push not push instruction [0x%08X]" % push_addr
                                         	print GetMnem(push_addr)
                                         	not_push_counter += 1
                                         	continue
 
                          	# Get new value
                          	push_value = GetOperandValue(push_addr, 0)
                          	byte_val = values_to_patch.get(push_value, None)
                          	if None == byte_val:
                                         	print " [*] fix_reg_push unexpected push value [0x%08X]" % push_addr
                                         	bad_push_counter += 1
                                         	continue
 
                          	# Patch code
                          	idaapi.patch_word(push_addr, 0x04EB) # EB 04 -&gt; Jmp $+4...
                          	idaapi.patch_long(push_addr + 2, 0x90909090) #
           	           	idaapi.patch_byte(push_addr + 6, byte_val)
 
                          	patched_counter += 1
           	print " [*] fix_reg_push - Total: [%d]\npatched functions: [%d]\nunpatched functions: [%d]" % (patched_counter + unpatched_counter, patched_counter, unpatched_counter)
 
           	
def main():
           	fix_reg_push(PUSH_REGISTER_ADDR)
 
if "__main__" == __name__:
           	main()
</pre>
<p><span style="font-weight: 400; color: #000000;">The code above is separated into a couple of sections:</span></p>
<ul>
<li><span style="font-weight: 400; color: #000000;">Calling my&nbsp;<code style="font-weight: 400; color: #111111; background-color: #eeeeee;">fix_reg_push</code><span style="font-weight: 400;"> function with the appropriate function address which handles the push register by value</span></span></li>
<li><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">Running through all the Xrefs of the function and making IDA identify the bytes as code if it hasn’t already. Otherwise there would be issues identifying opcodes later in the script</span></span></li>
<li><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400 color: #000000;">Making sure the xref is valid and working as expected. I don’t want to create any weird code patches so I make some necessary sanity checks</span></span></li>
<li><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">P<span>atching the code, changing the 7 original bytes to </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">PUSH &lt;reg&gt;</code><span> and </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">JMP &lt;byte&gt;</code><span> for better code clarity.</span></span></span></li>
</ul>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Lets examine the before and after results:</span></p>
<table style="width: 606px;">
<tbody>
<tr style="height: 22.3125px;">
<td style="width: 282.8px; height: 22.3125px;">Before</td>
<td style="width: 334.2px; height: 22.3125px;">After</td>
</tr>
<tr style="height: 406px;">
<td style="width: 282.8px; height: 406px;"><img src="http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=893&amp;height=608&amp;name=before_reg_patch.jpg" alt="" title="before_reg_patch.jpg" width="893" height="608" srcset="http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=447&amp;height=304&amp;name=before_reg_patch.jpg 447w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=893&amp;height=608&amp;name=before_reg_patch.jpg 893w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=1340&amp;height=912&amp;name=before_reg_patch.jpg 1340w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=1786&amp;height=1216&amp;name=before_reg_patch.jpg 1786w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=2233&amp;height=1520&amp;name=before_reg_patch.jpg 2233w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=2679&amp;height=1824&amp;name=before_reg_patch.jpg 2679w" sizes="(max-width: 893px) 100vw, 893px"></td>
<td style="width: 334.2px; height: 406px;"><img src="http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=667&amp;height=834&amp;name=after_reg_patch.jpg" alt="" title="after_reg_patch.jpg" width="667" height="834" srcset="http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=334&amp;height=417&amp;name=after_reg_patch.jpg 334w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=667&amp;height=834&amp;name=after_reg_patch.jpg 667w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=1001&amp;height=1251&amp;name=after_reg_patch.jpg 1001w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=1334&amp;height=1668&amp;name=after_reg_patch.jpg 1334w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=1668&amp;height=2085&amp;name=after_reg_patch.jpg 1668w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=2001&amp;height=2502&amp;name=after_reg_patch.jpg 2001w" sizes="(max-width: 667px) 100vw, 667px"></td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">As you can see, I translated the reg_push functions (all of them) to a readable simple de-obfuscated push opcodes which have a length of one byte. I could have just done a NOP-slide for the rest of the bytes left, but I decided to implement a jmp opcode instead with the memory I had left to overwrite. It’s a matter of taste. The code became much more readable and now I can finally read which register represents which value on the stack. This function was fixed at over 3,900 places in the code. So it was definitely worth it.</span></p>
<p><span style="font-weight: 400; color: #000000;">And that’s it for the first part.</span></p>
<p><span style="font-weight: 400; color: #000000;">Patching the code on IDA made everything a lot more readable in terms of static analysis. Next, there is still that spaghetti calling convention I will have to fix, but as I investigated more of the code, I noticed there are dozens of variations with different calculations being made, and for each one of those, there are a dozen more duplications which look identical to each other. The only logical thing left for me to do, was to make a regex to find every matching function.</span></p>
<p>&nbsp;</p>
<p style="text-align: center;"><span style="font-weight: 400;"><img src="http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=1720&amp;height=452&amp;name=spaghetti_functions.jpg" alt="" title="spaghetti_functions.jpg" width="1720" height="452" data-constrained="true" srcset="http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=860&amp;height=226&amp;name=spaghetti_functions.jpg 860w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=1720&amp;height=452&amp;name=spaghetti_functions.jpg 1720w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=2580&amp;height=678&amp;name=spaghetti_functions.jpg 2580w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=3440&amp;height=904&amp;name=spaghetti_functions.jpg 3440w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=4300&amp;height=1130&amp;name=spaghetti_functions.jpg 4300w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=5160&amp;height=1356&amp;name=spaghetti_functions.jpg 5160w" sizes="(max-width: 1720px) 100vw, 1720px"><span>(Fig. 6, three spaghetti functions found on the code, using add, xor and sub for calculations</span><span>)</span></span></p>
<p style="text-align: center;">&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Fortunately finding the common base between all functions wasn’t so hard. All of them have more or less the same prologue, and pretty much the same epilogue. So creating some kind of byte regex to find all of them (and fix them!) isn’t very hard. So I've done just that.</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400; color: #000000;">After automatically finding all of these spaghetti functions, I will patch the code just as I have done with the '</span><i><span style="font-weight: 400; color: #000000;">push_reg</span></i><span style="font-weight: 400; color: #000000;">' functions. Only this time I have a lot more "space" in terms of bytes to do so</span></span></span></p>
<p style="text-align: center;"><span style="font-weight: 400; color: #999999;"><span><span style="font-weight: 400; color: #999999;"><img src="http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=712&amp;height=81&amp;name=calling_convention.jpg" alt="" title="calling_convention.jpg" width="712" height="81" style="display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=356&amp;height=41&amp;name=calling_convention.jpg 356w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=712&amp;height=81&amp;name=calling_convention.jpg 712w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=1068&amp;height=122&amp;name=calling_convention.jpg 1068w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=1424&amp;height=162&amp;name=calling_convention.jpg 1424w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=1780&amp;height=203&amp;name=calling_convention.jpg 1780w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=2136&amp;height=243&amp;name=calling_convention.jpg 2136w" sizes="(max-width: 712px) 100vw, 712px">(Fig. 7, focusing on the sendto call<span>)</span></span></span></span></p>
<div style="text-align: center;">&nbsp;</div>
<p><span style="font-weight: 400; color: #000000;">In total, there are 16 bytes, that I would like to change to just CALL (5 bytes), so I have enough space to override as I want. This method is practically the same as the method I used before. So there is no reason to put another code block to show how its done. Looking for all variants of these functions gave me a result of almost 100 different variations, with a total of approximately 3,000 different Xrefs in the code (for all variants).</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400;"><span style="font-weight: 400; color: #000000;">The final result after patching both the spaghetti calling convention and the push registry by value:</span></span></span></span></p>
<div style="text-align: center;"><span style="font-weight: 400; color: #999999;"><span><span style="font-weight: 400; color: #999999;"><span style="font-weight: 400; color: #999999;"><img src="http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=729&amp;height=926&amp;name=final_patched.jpg" alt="Final Patch" title="final_patched.jpg" width="729" height="926" style="display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=365&amp;height=463&amp;name=final_patched.jpg 365w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=729&amp;height=926&amp;name=final_patched.jpg 729w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=1094&amp;height=1389&amp;name=final_patched.jpg 1094w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=1458&amp;height=1852&amp;name=final_patched.jpg 1458w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=1823&amp;height=2315&amp;name=final_patched.jpg 1823w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=2187&amp;height=2778&amp;name=final_patched.jpg 2187w" sizes="(max-width: 729px) 100vw, 729px">(Fig. 8, Final patch<span>)</span></span></span></span></span></div>
<p>&nbsp;</p>
<h1><span style="font-size: 30px;"><strong>You Can Run, But You Can’t Hide...</strong></span></h1>
<p><span style="font-weight: 400; color: #000000;">Finally, having the important parts de-obfuscated, I could continue on to the DGA. Let me pre announce, the authors intent to avoid being sinkholed payed off, good job! It has been a while since I've seen someone trying to protect their code and their DGA as much as they did. So let's get to it</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">Most malwares who have a DGA use some value which changes periodically. This one is no different and is based on the current date to calculate it’s DGA (Day, Month, Year). Though it's not as simple as it sounds: Instead of using some sort of builtin linear random function (such as </span><i><span style="font-weight: 400; color: #000000;">msvcsrt!rand </span></i><span style="font-weight: 400; color: #000000;">and </span><i><span style="font-weight: 400; color: #000000;">msvcrt!srand</span></i><span style="font-weight: 400; color: #000000;">), they implemented their own functions for making random numbers and setting the initial seed. Their MagicSeed (I'm going to use that term a lot), means the number calculated every day, generated by the current date for example is made out of 128 bits. Every time anything needs to obtain the MagicSeed's value, the MagicSeed changes as well. So I had to follow all of the code very carefully, not to miss anything regarding the MagicSeed's usage.</span></span></span></span></span></p>
<p><strong>How It All Works</strong></p>
<p><span style="font-weight: 400; color: #000000;">I will now explain how the malware reaches the C&amp;C server and the obfuscation made behind the DGA.</span></p>
<p><span style="font-weight: 400; color: #000000;">As you would expect from any malware, they make a simple domain list using a MagicSeed, then try to resolve each of the domains created, using google’s dns servers to prevent being dns-sinkholed, until one is being resolved and that would usually be the C&amp;C server. However, this is not our case because it would be too boring to talk about just that wouldn’t it?</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;"><span style="font-weight: 400;"><span style="font-weight: 400; color: #000000;">So as it gets more complicated, as when trying to resolve all of the generated domains, only the first domain which will be resolved into exactly two different IP addresses. &nbsp;For example, these domains (which are generated at 30/09/2016):</span></span></span></span></span></span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">&nbsp;</span></span></span></span></span></span></p>
<table style="border: 1px solid black; text-align: left; padding: 15px;">
<tbody>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><strong>Generated Domain</strong></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><strong>Resolved IP addresses</strong></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">jfwwqi.com</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">avljz.net</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">4.2.0.1</span></p>
<p><span style="font-weight: 400; color: #000000;">4.2.0.2</span></p>
<p><span style="font-weight: 400; color: #000000;">4.2.0.3</span></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">hlrhtvl.com &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">mcodqfban.com &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">192.168.0.1</span></p>
<p><span style="font-weight: 400; color: #000000;">192.168.0.2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">xdvhfogmw.pw &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">13.37.80.80 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">obsvi.com</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">igcvdloatwf.in</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">zcekjgrmmx.in</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">The only domain that will be used from this list would be</span></p>
<p><span style="font-weight: 400; color: #000000;">&nbsp;</span></p>
<table>
<tbody>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">mcodqfban.com &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">192.168.0.1</span></p>
<p><span style="font-weight: 400; color: #000000;">192.168.0.2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Because it is being resolved into two different IP addresses.</span></p>
<p><span style="font-weight: 400; color: #000000;">Yet, these two IP addresses have no direct connection to the C&amp;C server. They are just going to be another stepping stone in Nymaim's logic in order to create a new MagicSeed number.</span></p>
<p><span style="font-weight: 400; color: #000000;">And with that new MagicSeed, create a new domain list. with exactly the same algorithm as the first domain list was generated, But hold on, there is more:</span></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Before trying to use this newly created domain list, a checksum algorithm is used over the newly created domain list, and the result is compared with a builtin checksums list.</span></p>
<p><span style="font-weight: 400; color: #000000;">This probably means that the domains themselves are finite and have probably been pre-bought, or they are just waiting for the right time to buy a new domain that matches their checksum list.</span></p>
<p><span style="font-weight: 400; color: #000000;">After the list passes the checksum check, the first domain in the list is taken and its TLD is changed to ".COM".</span></p>
<p><span style="font-weight: 400; color: #000000;">After all this effort, I would guess that domain is all that is left and the IP addresses matching the resolving of this domain are what would be the C&amp;C server. However my guess was wrong. The IPs resolved from that newly created domain are not yet the correct IP addresses of the C&amp;C servers. For every IP address we get from the DNS request, a loop of xoring and rotation calculations are being made over each of the IP Addresses in order to obtain the real C&amp;C server IP addresses (<strong>Finally!</strong>). Let's summarize everything with a pseudo code:</span></p>
<p><span style="font-weight: 400; color: #000000;">DGACreation:</span></p>
<pre class="brush: py">tlds = [“.net”, “.com”, “.in”, “.pw”]
 
GenerateDomains(magic_num)
{
               domains = []
               
           	seed = CreateUniqueSeed(TODAYS_DATE)
           	rand = GetRandomNumber(seed)
           	
           	for(int i=0; i&lt;16; i++)
           	{
                          	domain_str = GenString(rand, seed, magic_num)
                          	domain_str += tlds[GetRandomNumber(seed)
                          	domains += [domain_str]
           	}
           	return domains
}
</pre>
<ul>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Creating a unique seed based on current date</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Generate random number from seed</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Create a domain string from generated random number and the seed</span><span style="font-weight: 400; color: #000000;"></span></li>
<li><span style="font-weight: 400; color: #000000;">Create a new random, use it to append TLD</span></li>
<li><span style="font-weight: 400; color: #000000;">Returns a list of 16 domains created</span></li>
</ul>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">ResolveDomain:</span></p>
<pre class="brush: py">ResolveDomains(domain_list)
{
               for(i =0, i&lt;16; i++)
               {
                          	ip_addresses = DnsResolve(domain_list[i])
                          	if (2 == ip_addresses.length())
                                         	return ip_addresses
           	}
}
</pre>
<ul>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Trying to resolve domain list ip addresses</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Check if exactly 2 IP addresses were obtained in the dns request</span></li>
<li><span style="font-weight: 400; color: #000000;">Return list of resolved addresses</span></li>
</ul>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Main:</span></p>
<pre class="brush: py">Main()
{
               domains = GenerateDomains(0)
           	ips = ResolveDomains(domains)

           	new_domains = GenerateDomains(ips)
           	domain = new_domains[0].replace(".com")
           	
           	real_ips = ResolveDomains(domain)
           	real_ips = XorIPS(real_ips)
           	
           	CommunicateWithRealServer(real_ips)
}
</pre>
<ul>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Generating first list of domains</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Get good matching ip addresses (Only 2 ip addresses)</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Generate new list of domains from the ips we got</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Change TLD of the first domain from the list generated</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Resolve domain</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Obtain real C&amp;C ip addresses through calculations</span></li>
<li><span style="font-weight: 400; color: #000000;">Communicate with C&amp;C</span></li>
</ul>
<p><span style="font-weight: 400; color: #000000;">I have also added a graph form for convenience</span></p>
<p style="text-align: center;"><span style="font-weight: 400; color: #999999;"><img src="http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=640&amp;name=graph.jpg" title="graph.jpg" width="640" style="width: 640px; display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=320&amp;name=graph.jpg 320w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=640&amp;name=graph.jpg 640w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=960&amp;name=graph.jpg 960w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=1280&amp;name=graph.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=1600&amp;name=graph.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=1920&amp;name=graph.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"><span>(Fig. 9, Graph format of the pseudo code)</span></span></p>
<p style="text-align: center;">&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">This is a lot of stuff to do in order just to get a C&amp;C server IP address. Those little tricks they used made it harder to reverse and understand the Nymaim code, and harder to sink-hole the malware as well.</span></p>
<p><span style="font-weight: 400; color: #000000;">So here we see prime example of how malware authors try to avoid being sink-holed by using obfuscation methods as protection for their code. </span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><br><span style="font-weight: 400; color: #000000;">But then again, everything can be conquered and beaten if you wear on your malware thinking-cap and put your mind into it.</span></span></span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400;">Ref analyzed sample:</span></span></span></p>
<ul style="display: block; padding-left: 40px;">
<li style="text-align: left; list-tyle-type: disc;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400;">c41ffc1fd6e3f5157181b6e45f45f4fe</span></span></span></li>
</ul>
<p style="text-align: center;"><span style="color: #333333;">&nbsp;# # #&nbsp;</span></p>
<p style="text-align: left;"><span style="color: #333333;">To see Nymaim and other malware that has bypassed your firewall and next gen gateway, try running the&nbsp;<span style="color: #ff6600;"><a href="http://www.seculert.com/seculert-javelin" target="_blank" style="color: #ff6600;">Seculert Javelin</a></span> Simulation Test. You may be surprised what it finds hiding in your&nbsp;network.</span></p>
<p style="text-align: center;">&nbsp;</p>
<p style="text-align: center;">&nbsp;</p>
                    <p></p>
                    
                    <div class="an-data-post">Oct 11, 2016 5:30:00 AM</div>
                    
                 </div>
                 <p class="an-link-social an-link-socials-content">
                    <a href="https://www.facebook.com/Seculert" title="Like Facebook"><img src="/hubfs/NewSeculertImages/blog/like-face.png"></a>
                    <a href="https://twitter.com/seculert" title="Like Twitter"><img src="/hubfs/NewSeculertImages/blog/like-twitter.png"></a>
                 </p>
            </div>
            
            
            
            <div class="col s12 m4 l3">
                <div class="an-sidebar">
                    <div class="an-widget">
                        <h3>categories</h3>
                        <ul class="an-category">
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/in-the-media" title=""><i class="material-icons">chevron_right</i> In the Media <span>&nbsp;(82)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/news-media" title=""><i class="material-icons">chevron_right</i> News &amp; Media <span>&nbsp;(82)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/resources-cat" title=""><i class="material-icons">chevron_right</i> Resources <span>&nbsp;(17)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/press-releases" title=""><i class="material-icons">chevron_right</i> Press Releases <span>&nbsp;(12)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/webinars" title=""><i class="material-icons">chevron_right</i> Webinars <span>&nbsp;(9)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/blogs" title=""><i class="material-icons">chevron_right</i> Blog <span>&nbsp;(5)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/white-papers" title=""><i class="material-icons">chevron_right</i> White Papers <span>&nbsp;(4)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/reports" title=""><i class="material-icons">chevron_right</i> Reports <span>&nbsp;(3)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/2015" title=""><i class="material-icons">chevron_right</i> 2015 <span>&nbsp;(2)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/events" title=""><i class="material-icons">chevron_right</i> Events <span>&nbsp;(2)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/product" title=""><i class="material-icons">chevron_right</i> Product <span>&nbsp;(2)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/451-report" title=""><i class="material-icons">chevron_right</i> 451 Report <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/black-hat-security-analytics" title=""><i class="material-icons">chevron_right</i> Black Hat, Security Analytics <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/brochures-and-datasheets" title=""><i class="material-icons">chevron_right</i> Brochures &amp; Datasheets <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/gateway-attack-detection" title=""><i class="material-icons">chevron_right</i> Gateway Attack Detection <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/in-the-news" title=""><i class="material-icons">chevron_right</i> In the News <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/javelin" title=""><i class="material-icons">chevron_right</i> Javelin <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/javelin-attack-simulator" title=""><i class="material-icons">chevron_right</i> Javelin Attack Simulator <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/uncategorized" title=""><i class="material-icons">chevron_right</i> Uncategorized <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                        </ul>
                    </div>
                    <div class="an-widget" style="display:none;">
                        <h3>social widget</h3>
                        <p class="an-link-social">
                            <a href="https://www.facebook.com/Seculert" title="Like Facebook"><img src="/hubfs/NewSeculertImages/blog/like-face.png"></a>
                            <a href="https://twitter.com/seculert" title="Like Twitter"><img src="/hubfs/NewSeculertImages/blog/like-twitter.png"></a>
                        </p>
                    </div>
                    <div class="an-widget">
                        <h3>recent post</h3>
                        <ul class="an-recent-post">
                        
                        
                            <li>
                                <div class="item-post">
                                    <div class="an-image">
                                        
                                        <a href="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware" title=""><img src="http://www.seculert.com/hubfs/NymaimLogo.jpg?t=1475841733970"></a>
                                        
                                    </div>
                                    <div class="an-content-des">
                                        <p>Nymaim: Deep Technical Dive - Adventures in Evasive Malware</p>
                                        <a href="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware" title="">Oct 11, 2016 5:30:00 AM</a> 
                                    </div> 
                                </div>
                            </li>
                        
                            <li>
                                <div class="item-post">
                                    <div class="an-image">
                                        
                                        <a href="http://www.seculert.com/blogs/ursnif-deep-technical-dive" title=""><img src=""></a>
                                        
                                    </div>
                                    <div class="an-content-des">
                                        <p>Ursnif: Deep Technical Dive</p>
                                        <a href="http://www.seculert.com/blogs/ursnif-deep-technical-dive" title="">Aug 30, 2016 4:23:13 PM</a> 
                                    </div> 
                                </div>
                            </li>
                        
                            <li>
                                <div class="item-post">
                                    <div class="an-image">
                                        
                                        <a href="http://www.seculert.com/blogs/possible-nation-state-attackers-projectsauron-to-covertly-eavesdrop-on-government-organizations" title=""><img src=""></a>
                                        
                                    </div>
                                    <div class="an-content-des">
                                        <p>Possible Nation State Attackers ProjectSauron to Covertly Eavesdrop on Government Organizations</p>
                                        <a href="http://www.seculert.com/blogs/possible-nation-state-attackers-projectsauron-to-covertly-eavesdrop-on-government-organizations" title="">Aug 19, 2016 1:33:51 PM</a> 
                                    </div> 
                                </div>
                            </li>
                        
                        </ul>
                    </div>
                    <div class="an-widget">
                        <h3>popular tags</h3>
                        <ul class="an-popular-tags">
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/in-the-media" title="">In the Media</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/news-media" title="">News &amp; Media</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/resources-cat" title="">Resources</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/press-releases" title="">Press Releases</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/webinars" title="">Webinars</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/blogs" title="">Blog</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/white-papers" title="">White Papers</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/reports" title="">Reports</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/2015" title="">2015</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/events" title="">Events</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/product" title="">Product</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/451-report" title="">451 Report</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/black-hat-security-analytics" title="">Black Hat, Security Analytics</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/brochures-and-datasheets" title="">Brochures &amp; Datasheets</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/gateway-attack-detection" title="">Gateway Attack Detection</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/in-the-news" title="">In the News</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/javelin" title="">Javelin</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/javelin-attack-simulator" title="">Javelin Attack Simulator</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/uncategorized" title="">Uncategorized</a></li>
                            
                        
                        </ul>
                    </div>
                </div>
             </div>
          </div>
     </div>
 </div>



<div class="blog-section" style="display:none">
    <div class="blog-post-wrapper cell-wrapper">
                <div class="blog-section">
            <div class="blog-post-wrapper cell-wrapper">
                <div class="section post-header">
                    <h1><span id="hs_cos_wrapper_name" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="text">Nymaim: Deep Technical Dive - Adventures in Evasive Malware</span></h1>
                    <div id="hubspot-author_data" class="hubspot-editable" data-hubspot-form-id="author_data" data-hubspot-name="Blog Author">
                        <span class="hs-author-label">Posted by</span>
                        
                            <a class="author-link" href="http://www.seculert.com/blogs/author/ariel-koren">Ariel Koren</a> on Oct 11, 2016 5:30:00 AM
                             <div class="hs-author-avatar"> <img src="http://www.seculert.com/hubfs/Ariel_seculert_avatar.jpeg?t=1475841733970" alt="Ariel Koren"> </div> 
                            
                                <div class="hs-author-social-section">
                                    <span class="hs-author-social-label">Find me on:</span>
                                    <div class="hs-author-social-links">
                                        
                                        
                                            <a href="https://www.linkedin.com/in/ariel-koren-4588b098" target="_blank" class="hs-author-social-link hs-social-linkedin">LinkedIn</a>
                                        
                                        
                                        
                                    </div>
                                </div>
                            
                        
                    </div>
                </div>
                <span id="hs_cos_wrapper_blog_social_sharing" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_blog_social_sharing" style="" data-hs-cos-general-type="widget" data-hs-cos-type="blog_social_sharing">
<div class="hs-blog-social-share">
    <ul class="hs-blog-social-share-list">
        
        <li class="hs-blog-social-share-item hs-blog-social-share-item-twitter">
            <!-- Twitter social share -->
            <a href="https://twitter.com/share" class="twitter-share-button" data-lang="en" data-url="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware" data-size="medium" data-text="Nymaim: Deep Technical Dive - Adventures in Evasive Malware">Tweet</a>
        </li>
        

        
        <li class="hs-blog-social-share-item hs-blog-social-share-item-linkedin">
            <!-- LinkedIn social share -->
            <script type="IN/Share" data-url="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware" data-showzero="true" data-counter="right"></script>
        </li>
        

        
        <li class="hs-blog-social-share-item hs-blog-social-share-item-facebook">
            <!-- Facebook share -->
            <div class="fb-like" data-href="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true" data-width="120"></div>
        </li>
        

        
        <li class="hs-blog-social-share-item hs-blog-social-share-item-google-plus">
            <!-- Google +1 -->
            <div class="g-plusone" data-size="medium" data-href="http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware"></div>
        </li>
        
    </ul>
 </div>

</span>
                <div class="section post-body">
                    <span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;">Nymaim is mostly known worldwide as a downloader, although it seems they evolved from former versions, now having new functionalities to obtain data on the machine with no need to download a new payload. Some of the exported functionalities allow harvesting passwords and browsers data from the machine, hidden on the file system until communication occurs. Payloads downloaded from the C&amp;C are not saved locally on the machine but instead are loaded dynamically to memory with a unique internal calling convention.</span></span></p>
<p><span style="font-weight: 400; color: #000000;">One of the signature features I noticed when I began analyzing the Nymaim payload were the novel anti-reverse engineering and obfuscation techniques. Frustrating the analyzer many different code pieces for the same function requires piecing them together in order to fully understand the code. Most of the code is heavily obfuscated using ‘spaghetti code’ methods but we'll dive into that in a 1 (bit).</span></p>
<!--more-->
<p><span style="font-weight: 400; color: #000000;">In addition to the already obfuscated code, the DGA (Domain generation algorithm) use quite an interesting technique to make sure it won't be sink-holed easily, as well as further challenging analyzation.</span></p>
<p><span style="font-weight: 400; color: #000000;">In this blog, I will review the anti-reverse engineering techniques the malware authors implemented in the code, explain the unique DGA they made, and show different automation concepts to conquer the code and make the analyzer’s life a lot easier.</span></p>
<p>&nbsp;</p>
<h1><span style="font-weight: 400; font-size: 18px;"><strong>And so it begins...</strong></span></h1>
<p><span style="font-weight: 400; color: #000000;">In general, when I dive into a new malware, I begin with a set of goals or objectives I need to discover and understand such as the DGA mechanism of a malware, or analyzing the protocol and functionality. When I focus on the DGA for instance, while debugging, I expect the malware to hit (at some point) a DNS resolving function such as </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">getaddrinfo</code><span style="font-weight: 400;">, </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">gethostbyname</code><span style="font-weight: 400; color: #000000;"> or any similar API. Unfortunately, Nymaim hit none of the expected DNS resolving APIs exported. Confused for a moment, I decided to try a breakpoint on the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function and indeed the breakpoint is hit. It is a crafted DNS request with a messed up Call Stack and I can't conclude anything definitive, I have to find the caller to the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function manually. Following the RETs and JMPs I finally get to the function called the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function. But wait, it looks so weird! (Dramatic drumming)</span></p>
<div style="text-align: center;"><span style="font-weight: 400;"><img src="http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=685&amp;height=503&amp;name=sendto_ida_snippet.jpg" alt="" title="sendto_ida_snippet.jpg" width="685" height="503" data-constrained="true" style="display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=343&amp;height=252&amp;name=sendto_ida_snippet.jpg 343w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=685&amp;height=503&amp;name=sendto_ida_snippet.jpg 685w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=1028&amp;height=755&amp;name=sendto_ida_snippet.jpg 1028w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=1370&amp;height=1006&amp;name=sendto_ida_snippet.jpg 1370w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=1713&amp;height=1258&amp;name=sendto_ida_snippet.jpg 1713w, http://www.seculert.com/hs-fs/hubfs/sendto_ida_snippet.jpg?t=1475841733970&amp;width=2055&amp;height=1509&amp;name=sendto_ida_snippet.jpg 2055w" sizes="(max-width: 685px) 100vw, 685px"></span><span style="font-weight: 400; color: #999999;">(Fig. 1, the calling convention to the sendto function)</span></div>
<p><span style="font-weight: 400; color: #000000;">no way this is the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function!</span></p>
<h1><strong>So, it continues! Obfuscation, legit code protection</strong></h1>
<p><span style="font-weight: 400; color: #000000;">Let us examine the IDA snippet above (Fig. 1), while keeping in mind what the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function looks like:<br><br></span></p>
<table style="height: 169px; background-color: #ffffff; margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">WS2_32!sendto(SOCKET s,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *buf,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; int len,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int flags,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const struct sockaddr *to,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int tolen)</span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">There are 6 arguments in total. After static analysis of the code, the arguments passed on the stack don’t make much sense in terms of what </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> is expecting (value wise). Also there are 9 push opcodes in total. Something fishy is going on in there. Let's examine the last call function </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">call sub_1805525</code><span style="font-weight: 400; color: #000000;"> which is the OPCODE I returned to manually from the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> function.</span></p>
<p><span style="font-weight: 400; color: #000000;">&lt;SpoilerAlert&gt;<br></span><span style="font-weight: 400; color: #000000;">&nbsp; &nbsp; This function is one of many spaghetti functions found in the code<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">&lt;/SpoilerAlert&gt;</span></span></p>
<p><span style="font-weight: 400;"><span style="font-weight: 400;"><img src="http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=640&amp;name=call_function.jpg" title="call_function.jpg" width="640" data-constrained="true" style="width: 640px; display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=320&amp;name=call_function.jpg 320w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=640&amp;name=call_function.jpg 640w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=960&amp;name=call_function.jpg 960w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=1280&amp;name=call_function.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=1600&amp;name=call_function.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/call_function.jpg?t=1475841733970&amp;width=1920&amp;name=call_function.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"></span></span></p>
<div style="text-align: center;"><span style="font-weight: 400; color: #999999;">(Fig. 2, How the called function looks like)</span></div>
<p><span style="font-weight: 400;"><span style="font-weight: 400;">&nbsp;</span></span></p>
<p>&nbsp;</p>
<img src="http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=203&amp;height=300&amp;name=stack.jpg" alt="" title="stack.jpg" width="203" height="300" data-constrained="true" style="float: right;" srcset="http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=102&amp;height=150&amp;name=stack.jpg 102w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=203&amp;height=300&amp;name=stack.jpg 203w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=305&amp;height=450&amp;name=stack.jpg 305w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=406&amp;height=600&amp;name=stack.jpg 406w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=508&amp;height=750&amp;name=stack.jpg 508w, http://www.seculert.com/hs-fs/hubfs/stack.jpg?t=1475841733970&amp;width=609&amp;height=900&amp;name=stack.jpg 609w" sizes="(max-width: 203px) 100vw, 203px">
<p><span style="font-weight: 400; color: #000000;">To fully comprehend what is going on, we will first have to understand how the stack would look after calling this function in terms of EBP offsets:</span></p>
<p><span style="font-weight: 400; color: #000000;">First of all pushing EAX (arg_8) and then two more DWORDS, arg_4 (0xCF260F5F) and arg_0 (0x30D8FC16).</span></p>
<p><span style="font-weight: 400; color: #000000;">Then calling the function (call sub_1805525) which will put the appropriate ret address as the last value on the stack and that’s all we need to know stack-wise for now when calling this function.</span></p>
<p><span style="font-weight: 400; color: #000000;">Then, inside the called function, the function's prologue happens</span></p>
<p>&nbsp;</p>
<table style="height: 35px; margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 261.6px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">push ebp<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;">mov ebp, esp</span></span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">This puts into the base register (EBP) the current stack address to relatively point to stack variables using EBP and not ESP. Let's see what this function does exactly (As seen on the IDA snippet above):</span></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">(0) + (1) Overwrite </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">arg_8</code><span style="font-weight: 400; color: #000000;"> with the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">RetAddress</code><span style="font-weight: 400; color: #000000;">, (2) + (3) sum the values of the two DWORDS pushed on the stack (</span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">arg_0 + arg_4</code><span style="font-weight: 400; color: #000000;">), (4) the result from the last operation will be added to the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">arg_8</code><span style="font-weight: 400; color: #000000;"> which was already overwritten with the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">RetAddress</code><span style="font-weight: 400;">.</span></p>
<p><span style="font-weight: 400; color: #000000;">Basically it receives two numbers and a dummy stack value, 3 arguments in total. Resulting in a new return address with the value of <code style="font-weight: 400; color: #111111; background-color: #eeeeee;">[ReturnAddress + arg_0 + arg_4]</code>.</span></p>
<p><span style="font-weight: 400; color: #000000;">Xreferencing this whole mathematical function shows me it is being called from 36 more places. There are dozens (!) more variants of this function and about 2600 different places in which all of the variants being called inside the code.</span></p>
<p><span style="font-weight: 400; color: #000000;">Back to analyzing, the new address should be:</span></p>
<p><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">[0x0183BF0B + 0x30D8FC16 + 0XCF260F5F]</code><span style="font-weight: 400; color: #000000;">, cutting the 32 bit part will result in </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">[0x0182CA80]</code></p>
<p style="text-align: center;"><img src="http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=598&amp;height=1046&amp;name=func_wrapper.jpg" alt="" title="func_wrapper.jpg" width="598" height="1046" data-constrained="true" srcset="http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=299&amp;height=523&amp;name=func_wrapper.jpg 299w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=598&amp;height=1046&amp;name=func_wrapper.jpg 598w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=897&amp;height=1569&amp;name=func_wrapper.jpg 897w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=1196&amp;height=2092&amp;name=func_wrapper.jpg 1196w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=1495&amp;height=2615&amp;name=func_wrapper.jpg 1495w, http://www.seculert.com/hs-fs/hubfs/func_wrapper.jpg?t=1475841733970&amp;width=1794&amp;height=3138&amp;name=func_wrapper.jpg 1794w" sizes="(max-width: 598px) 100vw, 598px">&nbsp;<br><span style="font-weight: 400; color: #999999;">(Fig. 3, API obfuscation for some api calls, sendto commented)</span></p>
<p><span style="font-weight: 400; color: #000000;">Great success! The above snippet (Fig. 3) is another part of the obfuscation. The function that would be called next (</span><strong><i>sub_180D32D</i></strong><span style="font-weight: 400; color: #000000;">) is some API-Wrapper. Actually there are no standard API calls anywhere in the code, everything is calculated dynamically... everything. It's terrible I know.</span></p>
<p><span style="font-weight: 400; color: #000000;">Diving into that API-Wrapper function is possible (and actually required for the most part). However I won't do that in the scope of this blog post.</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">So this spaghetti calling convention messes up the code and I will have to fix it if I want to do any effective static analysis of it. Before I present the solution for this problem, however, Let's examine the rest of the unresolved issues in the calling function to </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400;">.</span><br></span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;"><img src="http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=640&amp;name=reg_push.jpg" title="reg_push.jpg" width="640" data-constrained="true" style="display: block; margin-left: auto; margin-right: auto; width: 640px;" srcset="http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=320&amp;name=reg_push.jpg 320w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=640&amp;name=reg_push.jpg 640w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=960&amp;name=reg_push.jpg 960w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=1280&amp;name=reg_push.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=1600&amp;name=reg_push.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/reg_push.jpg?t=1475841733970&amp;width=1920&amp;name=reg_push.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"></span></span></p>
<p style="text-align: center;"><span style="font-weight: 400; color: #999999;">(Fig. 4, Caller to the sendto function, extra unresolved code)</span></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">The next thing we need to investigate, is the repeated function </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sub_183AC7E</code></p>
<p style="text-align: center;"><strong><i><img src="http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=640&amp;name=reg_push-1.jpg" title="reg_push-1.jpg" width="640" data-constrained="true" style="display: block; margin-left: auto; margin-right: auto; width: 640px;" srcset="http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=320&amp;name=reg_push-1.jpg 320w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=640&amp;name=reg_push-1.jpg 640w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=960&amp;name=reg_push-1.jpg 960w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=1280&amp;name=reg_push-1.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=1600&amp;name=reg_push-1.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/reg_push-1.jpg?t=1475841733970&amp;width=1920&amp;name=reg_push-1.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"></i></strong><span style="font-weight: 400; color: #999999;">(Fig. 5, push register obfuscation)</span></p>
<p style="text-align: center;">&nbsp;</p>
<p style="text-align: left;"><span style="font-weight: 400; color: #999999;"><span style="font-weight: 400; color: #000000;">I will make it easy, This is a huge switch-case of putting a register value on the stack dependent of the given value. For example, the following code (our </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">sendto</code><span style="font-weight: 400; color: #000000;"> scenario):</span></span></p>
<p style="text-align: left;">&nbsp;</p>
<table style="height: 35px; background-color: margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 261.6px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">seg000:0183BED7 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">10h<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BED9 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">72h ; 'r'<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEDB &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">call</span> <span style="font-weight: 400; color: #000000;">sub_183AC7E<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEE0 &nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push</span> <span style="font-weight: 400; color: #000000;">6Fh ; 'o'<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEE2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">call</span> <span style="font-weight: 400; color: #000000;">sub_183AC7E<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEE7 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">6Ch ; 'l'<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEE9 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">call</span> <span style="font-weight: 400; color: #000000;">sub_183AC7E<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEEE &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">73h ; 's'<br></span><span style="font-weight: 400; color: #000000;">seg000:0183BEF0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call &nbsp; sub_183AC7E<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">seg000:0183BEF5 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">dword ptr [ebp-184h]</span></span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<table style="height: 35px; background-color: #ffffff; margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 261.6px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">10h<br></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">esi<br></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">ebx<br></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">eax<br></span><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">edi<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">dword ptr [ebp-184h]</span></span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h1 style="text-align: left;"><span style="font-weight: 400; color: #000000; font-size: 30px;"><span style="font-weight: 400; color: #000000;"><strong>Tomāto-Tomăto, Potāto-Potăto It’s all the same to…</strong></span></span></h1>
<p><span style="font-weight: 400; color: #000000;">...the two problems I aim to solve. One is fixing that spaghetti code-calling convention, and to fix the <code style="font-weight: 400; color: #111111; background-color: #eeeeee;">push_reg</code> function. These two functions rule most of the code, so fixing these two should be a huge step forward in understanding the code and statically analyzing it.</span><span style="font-weight: 400;"><br><br></span></p>
<p><span style="font-weight: 400; color: #000000;">So how is it done? Easy, Magic!</span></p>
<p><span style="font-weight: 400; color: #000000;">or in its unofficial name, IDA-Python, scripting an automation process to go over all of the code, wherever one of these functions occur, fix it and change it to a simpler and more readable code format while retaining the same functionality.</span></p>
<p><span style="font-weight: 400; color: #000000;">So let's get practical shall we? Starting with the </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">push_reg</code><span style="font-weight: 400; color: #000000;"> function</span></p>
<p><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;"><strong><span style="font-weight: 400;">I need to change every call to that function, which is made up of two opcodes:</span></strong></span></span></p>
<table style="height: 35px; margin-left: auto; margin-right: auto;" width="265" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="width: 261.6px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">6A XX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">push</span> <span style="font-weight: 400; color: #000000;">&lt;BYTE&gt;<br></span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;"><span style="font-weight: 400; color: #000000;">E8 XX XX XX XX &nbsp;&nbsp;&nbsp;&nbsp;</span> <span style="font-weight: 400; color: #000000;">call</span> <span style="font-weight: 400;">&lt;DWORD&gt;</span></span></span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Push and Call, which are both in total 7 bytes in memory. If I could replace these 7 bytes with the appropriate values of the Push &lt;Register&gt; and do it over all of the code, it will be a big step in de-obfuscating the code.</span></p>
<p><span style="font-weight: 400; color: #000000;">So now that I know exactly what I want to replace, I wrote a script which does exactly that:</span></p>
<p>&nbsp;</p>
<pre class="brush: py">PUSH_REGISTER_ADDR = 0x0183AC7E
PUSH_REG_VALUE = 0x6C
SIZEOF_PUSH_BYTE = 2
 
def fix_reg_push(function_address):
               patched_counter = 0
               unpatched_counter = 0
               values_to_patch = {PUSH_REG_VALUE : 0x50,       	# push eax
                          	PUSH_REG_VALUE + 1 : 0x51,   	# push ecx
                          	PUSH_REG_VALUE + 2 : 0x52,   	# push edx
                          	PUSH_REG_VALUE + 3 : 0x53,   	# push ebx
                          	PUSH_REG_VALUE + 5 : 0x55,   	# push ebp
                          	PUSH_REG_VALUE + 6 : 0x56,   	# push esi
                          	PUSH_REG_VALUE + 7 : 0x57,   	# push edi}
 
           	# Go through all xrefs
           	for xcall in XrefsTo(function_address):
           	
                          	# Make code if is not already
                          	opcode_length = idc.MakeCode(xcall.frm - SIZEOF_PUSH_BYTE)
                          	if SIZEOF_PUSH_BYTE != opcode_length:
                                         	print " [*] fix_reg_push not code [0x%08X]" % push_addr
                                         	not_code_counter += 1
                                         	continue
                                         	
                          	# Obtain previous opcode address
                          	push_addr = idc.PrevHead(xcall.frm)
                          	
                          	# Sanity check 2
                          	if "push" != GetMnem(push_addr):
                                         	print " [*] fix_reg_push not push instruction [0x%08X]" % push_addr
                                         	print GetMnem(push_addr)
                                         	not_push_counter += 1
                                         	continue
 
                          	# Get new value
                          	push_value = GetOperandValue(push_addr, 0)
                          	byte_val = values_to_patch.get(push_value, None)
                          	if None == byte_val:
                                         	print " [*] fix_reg_push unexpected push value [0x%08X]" % push_addr
                                         	bad_push_counter += 1
                                         	continue
 
                          	# Patch code
                          	idaapi.patch_word(push_addr, 0x04EB) # EB 04 -&gt; Jmp $+4...
                          	idaapi.patch_long(push_addr + 2, 0x90909090) #
           	           	idaapi.patch_byte(push_addr + 6, byte_val)
 
                          	patched_counter += 1
           	print " [*] fix_reg_push - Total: [%d]\npatched functions: [%d]\nunpatched functions: [%d]" % (patched_counter + unpatched_counter, patched_counter, unpatched_counter)
 
           	
def main():
           	fix_reg_push(PUSH_REGISTER_ADDR)
 
if "__main__" == __name__:
           	main()
</pre>
<p><span style="font-weight: 400; color: #000000;">The code above is separated into a couple of sections:</span></p>
<ul>
<li><span style="font-weight: 400; color: #000000;">Calling my&nbsp;<code style="font-weight: 400; color: #111111; background-color: #eeeeee;">fix_reg_push</code><span style="font-weight: 400;"> function with the appropriate function address which handles the push register by value</span></span></li>
<li><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">Running through all the Xrefs of the function and making IDA identify the bytes as code if it hasn’t already. Otherwise there would be issues identifying opcodes later in the script</span></span></li>
<li><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400 color: #000000;">Making sure the xref is valid and working as expected. I don’t want to create any weird code patches so I make some necessary sanity checks</span></span></li>
<li><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">P<span>atching the code, changing the 7 original bytes to </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">PUSH &lt;reg&gt;</code><span> and </span><code style="font-weight: 400; color: #111111; background-color: #eeeeee;">JMP &lt;byte&gt;</code><span> for better code clarity.</span></span></span></li>
</ul>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Lets examine the before and after results:</span></p>
<table style="width: 606px;">
<tbody>
<tr style="height: 22.3125px;">
<td style="width: 282.8px; height: 22.3125px;">Before</td>
<td style="width: 334.2px; height: 22.3125px;">After</td>
</tr>
<tr style="height: 406px;">
<td style="width: 282.8px; height: 406px;"><img src="http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=893&amp;height=608&amp;name=before_reg_patch.jpg" alt="" title="before_reg_patch.jpg" width="893" height="608" srcset="http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=447&amp;height=304&amp;name=before_reg_patch.jpg 447w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=893&amp;height=608&amp;name=before_reg_patch.jpg 893w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=1340&amp;height=912&amp;name=before_reg_patch.jpg 1340w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=1786&amp;height=1216&amp;name=before_reg_patch.jpg 1786w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=2233&amp;height=1520&amp;name=before_reg_patch.jpg 2233w, http://www.seculert.com/hs-fs/hubfs/before_reg_patch.jpg?t=1475841733970&amp;width=2679&amp;height=1824&amp;name=before_reg_patch.jpg 2679w" sizes="(max-width: 893px) 100vw, 893px"></td>
<td style="width: 334.2px; height: 406px;"><img src="http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=667&amp;height=834&amp;name=after_reg_patch.jpg" alt="" title="after_reg_patch.jpg" width="667" height="834" srcset="http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=334&amp;height=417&amp;name=after_reg_patch.jpg 334w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=667&amp;height=834&amp;name=after_reg_patch.jpg 667w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=1001&amp;height=1251&amp;name=after_reg_patch.jpg 1001w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=1334&amp;height=1668&amp;name=after_reg_patch.jpg 1334w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=1668&amp;height=2085&amp;name=after_reg_patch.jpg 1668w, http://www.seculert.com/hs-fs/hubfs/after_reg_patch.jpg?t=1475841733970&amp;width=2001&amp;height=2502&amp;name=after_reg_patch.jpg 2001w" sizes="(max-width: 667px) 100vw, 667px"></td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">As you can see, I translated the reg_push functions (all of them) to a readable simple de-obfuscated push opcodes which have a length of one byte. I could have just done a NOP-slide for the rest of the bytes left, but I decided to implement a jmp opcode instead with the memory I had left to overwrite. It’s a matter of taste. The code became much more readable and now I can finally read which register represents which value on the stack. This function was fixed at over 3,900 places in the code. So it was definitely worth it.</span></p>
<p><span style="font-weight: 400; color: #000000;">And that’s it for the first part.</span></p>
<p><span style="font-weight: 400; color: #000000;">Patching the code on IDA made everything a lot more readable in terms of static analysis. Next, there is still that spaghetti calling convention I will have to fix, but as I investigated more of the code, I noticed there are dozens of variations with different calculations being made, and for each one of those, there are a dozen more duplications which look identical to each other. The only logical thing left for me to do, was to make a regex to find every matching function.</span></p>
<p>&nbsp;</p>
<p style="text-align: center;"><span style="font-weight: 400;"><img src="http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=1720&amp;height=452&amp;name=spaghetti_functions.jpg" alt="" title="spaghetti_functions.jpg" width="1720" height="452" data-constrained="true" srcset="http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=860&amp;height=226&amp;name=spaghetti_functions.jpg 860w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=1720&amp;height=452&amp;name=spaghetti_functions.jpg 1720w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=2580&amp;height=678&amp;name=spaghetti_functions.jpg 2580w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=3440&amp;height=904&amp;name=spaghetti_functions.jpg 3440w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=4300&amp;height=1130&amp;name=spaghetti_functions.jpg 4300w, http://www.seculert.com/hs-fs/hubfs/spaghetti_functions.jpg?t=1475841733970&amp;width=5160&amp;height=1356&amp;name=spaghetti_functions.jpg 5160w" sizes="(max-width: 1720px) 100vw, 1720px"><span>(Fig. 6, three spaghetti functions found on the code, using add, xor and sub for calculations</span><span>)</span></span></p>
<p style="text-align: center;">&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Fortunately finding the common base between all functions wasn’t so hard. All of them have more or less the same prologue, and pretty much the same epilogue. So creating some kind of byte regex to find all of them (and fix them!) isn’t very hard. So I've done just that.</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400; color: #000000;">After automatically finding all of these spaghetti functions, I will patch the code just as I have done with the '</span><i><span style="font-weight: 400; color: #000000;">push_reg</span></i><span style="font-weight: 400; color: #000000;">' functions. Only this time I have a lot more "space" in terms of bytes to do so</span></span></span></p>
<p style="text-align: center;"><span style="font-weight: 400; color: #999999;"><span><span style="font-weight: 400; color: #999999;"><img src="http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=712&amp;height=81&amp;name=calling_convention.jpg" alt="" title="calling_convention.jpg" width="712" height="81" style="display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=356&amp;height=41&amp;name=calling_convention.jpg 356w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=712&amp;height=81&amp;name=calling_convention.jpg 712w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=1068&amp;height=122&amp;name=calling_convention.jpg 1068w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=1424&amp;height=162&amp;name=calling_convention.jpg 1424w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=1780&amp;height=203&amp;name=calling_convention.jpg 1780w, http://www.seculert.com/hs-fs/hubfs/calling_convention.jpg?t=1475841733970&amp;width=2136&amp;height=243&amp;name=calling_convention.jpg 2136w" sizes="(max-width: 712px) 100vw, 712px">(Fig. 7, focusing on the sendto call<span>)</span></span></span></span></p>
<div style="text-align: center;">&nbsp;</div>
<p><span style="font-weight: 400; color: #000000;">In total, there are 16 bytes, that I would like to change to just CALL (5 bytes), so I have enough space to override as I want. This method is practically the same as the method I used before. So there is no reason to put another code block to show how its done. Looking for all variants of these functions gave me a result of almost 100 different variations, with a total of approximately 3,000 different Xrefs in the code (for all variants).</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400;"><span style="font-weight: 400; color: #000000;">The final result after patching both the spaghetti calling convention and the push registry by value:</span></span></span></span></p>
<div style="text-align: center;"><span style="font-weight: 400; color: #999999;"><span><span style="font-weight: 400; color: #999999;"><span style="font-weight: 400; color: #999999;"><img src="http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=729&amp;height=926&amp;name=final_patched.jpg" alt="Final Patch" title="final_patched.jpg" width="729" height="926" style="display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=365&amp;height=463&amp;name=final_patched.jpg 365w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=729&amp;height=926&amp;name=final_patched.jpg 729w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=1094&amp;height=1389&amp;name=final_patched.jpg 1094w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=1458&amp;height=1852&amp;name=final_patched.jpg 1458w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=1823&amp;height=2315&amp;name=final_patched.jpg 1823w, http://www.seculert.com/hs-fs/hubfs/final_patched.jpg?t=1475841733970&amp;width=2187&amp;height=2778&amp;name=final_patched.jpg 2187w" sizes="(max-width: 729px) 100vw, 729px">(Fig. 8, Final patch<span>)</span></span></span></span></span></div>
<p>&nbsp;</p>
<h1><span style="font-size: 30px;"><strong>You Can Run, But You Can’t Hide...</strong></span></h1>
<p><span style="font-weight: 400; color: #000000;">Finally, having the important parts de-obfuscated, I could continue on to the DGA. Let me pre announce, the authors intent to avoid being sinkholed payed off, good job! It has been a while since I've seen someone trying to protect their code and their DGA as much as they did. So let's get to it</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">Most malwares who have a DGA use some value which changes periodically. This one is no different and is based on the current date to calculate it’s DGA (Day, Month, Year). Though it's not as simple as it sounds: Instead of using some sort of builtin linear random function (such as </span><i><span style="font-weight: 400; color: #000000;">msvcsrt!rand </span></i><span style="font-weight: 400; color: #000000;">and </span><i><span style="font-weight: 400; color: #000000;">msvcrt!srand</span></i><span style="font-weight: 400; color: #000000;">), they implemented their own functions for making random numbers and setting the initial seed. Their MagicSeed (I'm going to use that term a lot), means the number calculated every day, generated by the current date for example is made out of 128 bits. Every time anything needs to obtain the MagicSeed's value, the MagicSeed changes as well. So I had to follow all of the code very carefully, not to miss anything regarding the MagicSeed's usage.</span></span></span></span></span></p>
<p><strong>How It All Works</strong></p>
<p><span style="font-weight: 400; color: #000000;">I will now explain how the malware reaches the C&amp;C server and the obfuscation made behind the DGA.</span></p>
<p><span style="font-weight: 400; color: #000000;">As you would expect from any malware, they make a simple domain list using a MagicSeed, then try to resolve each of the domains created, using google’s dns servers to prevent being dns-sinkholed, until one is being resolved and that would usually be the C&amp;C server. However, this is not our case because it would be too boring to talk about just that wouldn’t it?</span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400;"><span style="font-weight: 400;"><span style="font-weight: 400; color: #000000;">So as it gets more complicated, as when trying to resolve all of the generated domains, only the first domain which will be resolved into exactly two different IP addresses. &nbsp;For example, these domains (which are generated at 30/09/2016):</span></span></span></span></span></span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;"><span style="font-weight: 400; color: #000000;">&nbsp;</span></span></span></span></span></span></p>
<table style="border: 1px solid black; text-align: left; padding: 15px;">
<tbody>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><strong>Generated Domain</strong></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><strong>Resolved IP addresses</strong></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">jfwwqi.com</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">avljz.net</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">4.2.0.1</span></p>
<p><span style="font-weight: 400; color: #000000;">4.2.0.2</span></p>
<p><span style="font-weight: 400; color: #000000;">4.2.0.3</span></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">hlrhtvl.com &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">mcodqfban.com &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">192.168.0.1</span></p>
<p><span style="font-weight: 400; color: #000000;">192.168.0.2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">xdvhfogmw.pw &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">13.37.80.80 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">obsvi.com</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">igcvdloatwf.in</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">zcekjgrmmx.in</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><i><span style="font-weight: 400; color: #000000;">&lt;NotResolved&gt;</span></i></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">The only domain that will be used from this list would be</span></p>
<p><span style="font-weight: 400; color: #000000;">&nbsp;</span></p>
<table>
<tbody>
<tr>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">mcodqfban.com &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
<td style="width: 256.4px; border: 1px solid black; text-align: left; padding: 15px;">
<p><span style="font-weight: 400; color: #000000;">192.168.0.1</span></p>
<p><span style="font-weight: 400; color: #000000;">192.168.0.2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Because it is being resolved into two different IP addresses.</span></p>
<p><span style="font-weight: 400; color: #000000;">Yet, these two IP addresses have no direct connection to the C&amp;C server. They are just going to be another stepping stone in Nymaim's logic in order to create a new MagicSeed number.</span></p>
<p><span style="font-weight: 400; color: #000000;">And with that new MagicSeed, create a new domain list. with exactly the same algorithm as the first domain list was generated, But hold on, there is more:</span></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Before trying to use this newly created domain list, a checksum algorithm is used over the newly created domain list, and the result is compared with a builtin checksums list.</span></p>
<p><span style="font-weight: 400; color: #000000;">This probably means that the domains themselves are finite and have probably been pre-bought, or they are just waiting for the right time to buy a new domain that matches their checksum list.</span></p>
<p><span style="font-weight: 400; color: #000000;">After the list passes the checksum check, the first domain in the list is taken and its TLD is changed to ".COM".</span></p>
<p><span style="font-weight: 400; color: #000000;">After all this effort, I would guess that domain is all that is left and the IP addresses matching the resolving of this domain are what would be the C&amp;C server. However my guess was wrong. The IPs resolved from that newly created domain are not yet the correct IP addresses of the C&amp;C servers. For every IP address we get from the DNS request, a loop of xoring and rotation calculations are being made over each of the IP Addresses in order to obtain the real C&amp;C server IP addresses (<strong>Finally!</strong>). Let's summarize everything with a pseudo code:</span></p>
<p><span style="font-weight: 400; color: #000000;">DGACreation:</span></p>
<pre class="brush: py">tlds = [“.net”, “.com”, “.in”, “.pw”]
 
GenerateDomains(magic_num)
{
               domains = []
               
           	seed = CreateUniqueSeed(TODAYS_DATE)
           	rand = GetRandomNumber(seed)
           	
           	for(int i=0; i&lt;16; i++)
           	{
                          	domain_str = GenString(rand, seed, magic_num)
                          	domain_str += tlds[GetRandomNumber(seed)
                          	domains += [domain_str]
           	}
           	return domains
}
</pre>
<ul>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Creating a unique seed based on current date</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Generate random number from seed</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Create a domain string from generated random number and the seed</span><span style="font-weight: 400; color: #000000;"></span></li>
<li><span style="font-weight: 400; color: #000000;">Create a new random, use it to append TLD</span></li>
<li><span style="font-weight: 400; color: #000000;">Returns a list of 16 domains created</span></li>
</ul>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">ResolveDomain:</span></p>
<pre class="brush: py">ResolveDomains(domain_list)
{
               for(i =0, i&lt;16; i++)
               {
                          	ip_addresses = DnsResolve(domain_list[i])
                          	if (2 == ip_addresses.length())
                                         	return ip_addresses
           	}
}
</pre>
<ul>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Trying to resolve domain list ip addresses</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Check if exactly 2 IP addresses were obtained in the dns request</span></li>
<li><span style="font-weight: 400; color: #000000;">Return list of resolved addresses</span></li>
</ul>
<p>&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">Main:</span></p>
<pre class="brush: py">Main()
{
               domains = GenerateDomains(0)
           	ips = ResolveDomains(domains)

           	new_domains = GenerateDomains(ips)
           	domain = new_domains[0].replace(".com")
           	
           	real_ips = ResolveDomains(domain)
           	real_ips = XorIPS(real_ips)
           	
           	CommunicateWithRealServer(real_ips)
}
</pre>
<ul>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Generating first list of domains</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Get good matching ip addresses (Only 2 ip addresses)</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Generate new list of domains from the ips we got</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Change TLD of the first domain from the list generated</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Resolve domain</span></li>
<li><span style="font-weight: 400; color: #000000;"></span><span style="font-weight: 400; color: #000000;">Obtain real C&amp;C ip addresses through calculations</span></li>
<li><span style="font-weight: 400; color: #000000;">Communicate with C&amp;C</span></li>
</ul>
<p><span style="font-weight: 400; color: #000000;">I have also added a graph form for convenience</span></p>
<p style="text-align: center;"><span style="font-weight: 400; color: #999999;"><img src="http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=640&amp;name=graph.jpg" title="graph.jpg" width="640" style="width: 640px; display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=320&amp;name=graph.jpg 320w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=640&amp;name=graph.jpg 640w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=960&amp;name=graph.jpg 960w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=1280&amp;name=graph.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=1600&amp;name=graph.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/graph.jpg?t=1475841733970&amp;width=1920&amp;name=graph.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"><span>(Fig. 9, Graph format of the pseudo code)</span></span></p>
<p style="text-align: center;">&nbsp;</p>
<p><span style="font-weight: 400; color: #000000;">This is a lot of stuff to do in order just to get a C&amp;C server IP address. Those little tricks they used made it harder to reverse and understand the Nymaim code, and harder to sink-hole the malware as well.</span></p>
<p><span style="font-weight: 400; color: #000000;">So here we see prime example of how malware authors try to avoid being sink-holed by using obfuscation methods as protection for their code. </span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><br><span style="font-weight: 400; color: #000000;">But then again, everything can be conquered and beaten if you wear on your malware thinking-cap and put your mind into it.</span></span></span></p>
<p style="text-align: left;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400;">Ref analyzed sample:</span></span></span></p>
<ul style="display: block; padding-left: 40px;">
<li style="text-align: left; list-tyle-type: disc;"><span style="font-weight: 400; color: #000000;"><span><span style="font-weight: 400;">c41ffc1fd6e3f5157181b6e45f45f4fe</span></span></span></li>
</ul>
<p style="text-align: center;"><span style="color: #333333;">&nbsp;# # #&nbsp;</span></p>
<p style="text-align: left;"><span style="color: #333333;">To see Nymaim and other malware that has bypassed your firewall and next gen gateway, try running the&nbsp;<span style="color: #ff6600;"><a href="http://www.seculert.com/seculert-javelin" target="_blank" style="color: #ff6600;">Seculert Javelin</a></span> Simulation Test. You may be surprised what it finds hiding in your&nbsp;network.</span></p>
<p style="text-align: center;">&nbsp;</p>
<p style="text-align: center;">&nbsp;</p></span>
                </div>
                
                     <p id="hubspot-topic_data"> Topics:
                        
                            <a class="topic-link" href="http://www.seculert.com/blogs/topic/blogs">Blog</a>
                        
                     </p>
                
            </div>
        </div>


        <!-- Optional: Blog Author Bio Box -->
        

    </div>
</div></div>

</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-5 ">
<div class="row-fluid ">
<div class="container"><div class="row"><div class="an-form-subscrible">
<div class="span12 widget-span widget-type-blog_subscribe " style="" data-widget-type="blog_subscribe" data-x="0" data-w="12">
<div class="cell-wrapper layout-widget-wrapper">
<span id="hs_cos_wrapper_module_14504709930284405" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_blog_subscribe" style="" data-hs-cos-general-type="widget" data-hs-cos-type="blog_subscribe"><h3 id="hs_cos_wrapper_module_14504709930284405_title" class="hs_cos_wrapper form-title" data-hs-cos-general-type="widget_field" data-hs-cos-type="text">Subscribe to Email Updates</h3>

<div id="hs_form_target_module_14504709930284405"></div>

  
 


</span></div><!--end layout-widget-wrapper -->
</div><!--end widget-span -->
</div></div></div>
</div><!--end row-->
</div><!--end row-wrapper -->

</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-6 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-raw_jinja " style="" data-widget-type="raw_jinja" data-x="0" data-w="12">
<div class="parallax-container valign-wrapper an-content-latest-blog an-content-form-section">
    <div class="section no-pad-bot">
      <div class="container">
        <h2 class="center an-title-section">Contact Us</h2>
        <div class="row">
          <h5 class="header col s12 center"> </h5>
          <div class="an-content-form">
            <span id="hs_cos_wrapper_contact_form" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_form" style="" data-hs-cos-general-type="widget" data-hs-cos-type="form"><h3 id="hs_cos_wrapper_contact_form_title" class="hs_cos_wrapper form-title" data-hs-cos-general-type="widget_field" data-hs-cos-type="text"></h3>

<div id="hs_form_target_contact_form"></div>

    
     


</span>
            <div class="clearfix"></div>  
          </div>    
        </div>
      </div>
    </div>
    <div class="parallax"><img src="" alt="Unsplashed background img 2"></div>
</div></div><!--end widget-span -->

</div><!--end row-->
</div><!--end row-wrapper -->

<div class="row-fluid-wrapper row-depth-1 row-number-7 ">
<div class="row-fluid ">
<div class="span12 widget-span widget-type-global_widget " style="" data-widget-type="global_widget" data-x="0" data-w="12">
<div class="cell-wrapper layout-widget-wrapper">
<span id="hs_cos_wrapper_newseculert_footer" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_raw_html" style="" data-hs-cos-general-type="widget" data-hs-cos-type="raw_html" data-global-widget-id="3408863518">  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
        <p class="center">
          <a href="http://www.linkedin.com/company/seculert" title="Linkin"><img src="/hubfs/NewSeculertImages/icon-linkin.png" alt=""></a>
          <a href="https://twitter.com/seculert" title="Twitter"><img src="/hubfs/NewSeculertImages/icon-twiter.png" alt=""></a>
          <a href="https://www.facebook.com/Seculert" title="Facebook"><img src="/hubfs/NewSeculertImages/icon-face.png" alt=""></a>
        </p>
        <p class="center">© 2016 Seculert All Rights Reserved <a href="/privacy" title="Privacy Policy">Privacy Policy</a> | <a href="/terms-of-services" title="Terms of Service">Terms of Service</a> | <a href="/contact-us" title="Contact Us">Contact Us</a></p>
      </div>
    </div>
  </footer></span></div><!--end layout-widget-wrapper -->
</div><!--end widget-span -->
</div><!--end row-->
</div><!--end row-wrapper -->

    </div><!--end body -->
</div><!--end body wrapper -->

<div class="footer-container-wrapper">
    <div class="footer-container container-fluid">


    </div><!--end footer -->
</div><!--end footer wrapper -->

    
<script type="text/javascript" src="https://static.hsstatic.net/content_shared_assets/static-1.4032/js/public_common.js"></script>

    <!--[if lte IE 8]>
    <script charset="utf-8" src="https://js.hsforms.net/forms/v2-legacy.js"></script>
    <![endif]-->
 
<script src="https://js.hsforms.net/forms/v2.js"></script>

  <script>
      hbspt.forms.create({
          portalId: '237610',
          formId: '075be741-0339-4f22-a2f0-68ec7ccde5db',
          formInstanceId: '5172',
          pageId: 4401471434,
          pageName: 'Nymaim: Deep Technical Dive - Adventures in Evasive Malware',
          contentType: 'blog-post',
          
          redirectUrl: 'http://www.seculert.com/blogs/nymaim-deep-technical-dive-adventures-in-evasive-malware?hsFormKey=628a5c734f846536a56c2397031cb647#module_14504709930284405',
          
          
          css: '',
          target: '#hs_form_target_module_14504709930284405',
          
          formData: {
            cssClass: 'hs-form stacked'
          }
      });
  </script>


        <!--[if lte IE 8]>
        <script charset="utf-8" src="https://js.hsforms.net/forms/v2-legacy.js"></script>
        <![endif]-->
     

    <script>
        hbspt.forms.create({
            portalId: '237610',
            formId: '4d7e59c0-c8ee-4551-8cba-25515162ee14',
            formInstanceId: '2105',
            pageId: 4401471434,
            
            
            
            
            pageName: "Nymaim: Deep Technical Dive - Adventures in Evasive Malware",
            
            
            
            
            css: '',
            target: '#hs_form_target_contact_form',
            
            
            
            
            
            contentType: "blog-post",
            
            formData: {
            cssClass: 'hs-form stacked hs-custom-form'
            }
        });
    </script>


<!-- Start of HubSpot Analytics Code -->
<script type="text/javascript">
var _hsq = _hsq || [];
_hsq.push(["setContentType", "blog-post"]);
_hsq.push(["setCanonicalUrl", "http:\/\/www.seculert.com\/blogs\/nymaim-deep-technical-dive-adventures-in-evasive-malware"]);
_hsq.push(["setPageId", "4401471434"]);
_hsq.push(["setContentMetadata", {
    "contentPageId": 4401471434,
    "legacyPageId": "4401471434",
    "contentGroupId": 294026020,
    "abTestId": null,
    "languageVariantId": 4401471434,
    "languageCode": null
}]);
_hsq.push(["setTargetedContentMetadata", []]);


    (function(d,s,i,r) {
        if (d.getElementById(i)){return;}
        var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
        n.id=i;n.src='//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/237610.js';
        e.parentNode.insertBefore(n, e);
    })(document,"script","hs-analytics",300000);


</script>



<!-- End of HubSpot Analytics Code -->


<script type="text/javascript">
var hsVars = {
    ticks: 1476319568424,
    page_id: 4401471434,
    content_group_id: 294026020,
    portal_id: 237610,
    app_hs_base_url: "https://app.hubspot.com"
}
</script>



<!--— DO NOT REMOVE —-->
<script src="http://cdn2.hubspot.net/hub/237610/hub_generated/style_manager/1418906521047/custom/page/Seculert-Dec2014-theme/Seculert-Dec2014-main.min.js"></script>
<!--— END DO NOT REMOVE —-->
<!-- Force24 Tracking-->
<script type="text/javascript" language="javascript">
    var clientId = '1D5A0697-EFC4-E511-866F-0050568C0022'; // Insert client id here
    document.write(unescape("%3Cscript src='" + document.location.protocol + 
    "//tracking1.force24.co.uk/tracking/script/" + clientId + 
    "' type='text/javascript' language='javascript'%3E%3C/script%3E")); 
    document.write(unescape("%3Cscript src='" + document.location.protocol + 
    "//tracking1.force24.co.uk/tracking/script/capture/" + clientId + 
    "' type='text/javascript' language='javascript'%3E%3C/script%3E"));
</script>
<!--End Force24 Tracking-->
<!--Syntax highlighting-->
<script type="text/javascript" src="shCore.js"></script>
<!--
    Autoload instructions http://alexgorbatchev.com/SyntaxHighlighter/manual/api/autoloader.html
-->
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPython.js" type="text/javascript"></script> 
<script src="http://agorbatchev.typepad.com/pub/sh/3_0_83/scripts/shBrushcpp.js" type="text/javascript"></script> 
<script type="text/javascript">
      SyntaxHighlighter.all();
</script>
<!--End Syntax highlighting-->


<div id="fb-root"></div>
 <script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&status=0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
  window.___gcfg = {
    lang: 'en-US',
    parsetags: 'onload'
  };
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/platform.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
 


    <!-- Generated by the HubSpot Template Builder - template version 1.03 -->

<!-- end coded_template: id:3368679407 path:generated_layouts/3368679387.html -->
</body></html>